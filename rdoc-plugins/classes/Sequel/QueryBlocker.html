<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Sequel::QueryBlocker</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Sequel::QueryBlocker
</h1>
<ol class='paths'>
<li>
<a href="../../files/lib/sequel/extensions/query_blocker_rb.html">lib/sequel/extensions/query_blocker.rb</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'></div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-extended">extended</a></li>
</ol>
<h3>Public Instance</h3>
<ol>
<li><a href="#method-i-allow_queries">allow_queries</a></li>
<li><a href="#method-i-block_queries">block_queries</a></li>
<li><a href="#method-i-block_queries-3F">block_queries?</a></li>
<li><a href="#method-i-log_connection_yield">log_connection_yield</a></li>
<li><a href="#method-i-valid_connection-3F">valid_connection?</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='class-list'>
<h2>Classes and Modules</h2>
<ol>
<li><a href="QueryBlocker/BlockedQuery.html">Sequel::QueryBlocker::BlockedQuery</a></li>
</ol>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-extended'>
<a name='method-c-extended'></a>
<div class='synopsis'>
<span class='name'>extended</span><span class='arguments'>(db)</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-extended-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-extended-source'>   <span class="ruby-comment"># File lib/sequel/extensions/query_blocker.rb</span>
<span class="line-num">65</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">extended</span>(<span class="ruby-identifier">db</span>)
<span class="line-num">66</span>   <span class="ruby-identifier">db</span>.<span class="ruby-identifier">instance_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num">67</span>     <span class="ruby-ivar">@blocked_query_scopes</span> <span class="ruby-operator">||=</span> {}
<span class="line-num">68</span>   <span class="ruby-keyword">end</span>
<span class="line-num">69</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<h2>Public Instance methods</h2>
<div class='method public-instance' id='method-method-i-allow_queries'>
<a name='method-i-allow_queries'></a>
<div class='synopsis'>
<span class='name'>allow_queries</span><span class='arguments'>(opts=OPTS, &block)</span>

</div>
<div class='description'>

<p>Allow queries inside the block.  Only useful if they are already blocked for the same scope. Useful for blocking queries generally, and only allowing them in specific places.  Takes the same :scope option as <a href="QueryBlocker.html#method-i-block_queries"><code>block_queries</code></a>.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-allow_queries-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-allow_queries-source'>    <span class="ruby-comment"># File lib/sequel/extensions/query_blocker.rb</span>
<span class="line-num">105</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">allow_queries</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">106</span>   <span class="ruby-identifier">_allow_or_block_queries</span>(<span class="ruby-keyword">false</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">107</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-block_queries'>
<a name='method-i-block_queries'></a>
<div class='synopsis'>
<span class='name'>block_queries</span><span class='arguments'>(opts=OPTS, &block)</span>

</div>
<div class='description'>

<p>Reject (raise an <a href="QueryBlocker/BlockedQuery.html"><code>BlockedQuery</code></a> exception) if there is an attempt to execute a query/statement inside the block.</p>

<p>The :scope option indicates which queries are rejected inside the block:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>:global </td><td>
<p>This is the default, and rejects all queries.</p>
</td></tr><tr><td class='label'>:thread </td><td>
<p>Reject all queries in the current thread.</p>
</td></tr><tr><td class='label'>:fiber </td><td>
<p>Reject all queries in the current fiber.</p>
</td></tr><tr><td class='label'>Thread </td><td>
<p>Reject all queries in the given thread.</p>
</td></tr><tr><td class='label'>Fiber </td><td>
<p>Reject all queries in the given fiber.</p>
</td></tr></tbody></table>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-block_queries-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-block_queries-source'>    <span class="ruby-comment"># File lib/sequel/extensions/query_blocker.rb</span>
<span class="line-num">119</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">block_queries</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">120</span>   <span class="ruby-identifier">_allow_or_block_queries</span>(<span class="ruby-keyword">true</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">121</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-block_queries-3F'>
<a name='method-i-block_queries-3F'></a>
<div class='synopsis'>
<span class='name'>block_queries?</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>Whether queries are currently blocked.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-block_queries-3F-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-block_queries-3F-source'>    <span class="ruby-comment"># File lib/sequel/extensions/query_blocker.rb</span>
<span class="line-num"> 93</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">block_queries?</span>
<span class="line-num"> 94</span>   <span class="ruby-identifier">b</span> = <span class="ruby-ivar">@blocked_query_scopes</span>
<span class="line-num"> 95</span>   <span class="ruby-identifier">b</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-constant">Fiber</span>.<span class="ruby-identifier">current</span>) <span class="ruby-keyword">do</span>
<span class="line-num"> 96</span>     <span class="ruby-identifier">b</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>) <span class="ruby-keyword">do</span>
<span class="line-num"> 97</span>       <span class="ruby-identifier">b</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:global</span>, <span class="ruby-keyword">false</span>)
<span class="line-num"> 98</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 99</span>   <span class="ruby-keyword">end</span>
<span class="line-num">100</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-log_connection_yield'>
<a name='method-i-log_connection_yield'></a>
<div class='synopsis'>
<span class='name'>log_connection_yield</span><span class='arguments'>(sql, conn, args=nil)</span>

</div>
<div class='description'>

<p>Check whether queries are blocked before executing them.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-log_connection_yield-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-log_connection_yield-source'>   <span class="ruby-comment"># File lib/sequel/extensions/query_blocker.rb</span>
<span class="line-num">83</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">log_connection_yield</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">conn</span>, <span class="ruby-identifier">args</span>=<span class="ruby-keyword">nil</span>)
<span class="line-num">84</span>   <span class="ruby-comment"># All database adapters should be calling this method around</span>
<span class="line-num">85</span>   <span class="ruby-comment"># query execution (otherwise the queries would not get logged),</span>
<span class="line-num">86</span>   <span class="ruby-comment"># ensuring the blocking is checked.  Any database adapter issuing</span>
<span class="line-num">87</span>   <span class="ruby-comment"># a query without calling this method is considered buggy.</span>
<span class="line-num">88</span>   <span class="ruby-identifier">check_blocked_queries!</span>
<span class="line-num">89</span>   <span class="ruby-keyword">super</span>
<span class="line-num">90</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-valid_connection-3F'>
<a name='method-i-valid_connection-3F'></a>
<div class='synopsis'>
<span class='name'>valid_connection?</span><span class='arguments'>(conn)</span>

</div>
<div class='description'>

<p>If checking a connection for validity, and a <a href="QueryBlocker/BlockedQuery.html"><code>BlockedQuery</code></a> exception is raised, treat it as a valid connection.  You cannot check whether the connection is valid without issuing a query, and if queries are blocked, you need to assume it is valid or assume it is not.  Since it most cases it will be valid, this assumes validity.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-valid_connection-3F-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-valid_connection-3F-source'>   <span class="ruby-comment"># File lib/sequel/extensions/query_blocker.rb</span>
<span class="line-num">76</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">valid_connection?</span>(<span class="ruby-identifier">conn</span>)
<span class="line-num">77</span>   <span class="ruby-keyword">super</span>
<span class="line-num">78</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">BlockedQuery</span>
<span class="line-num">79</span>   <span class="ruby-keyword">true</span>
<span class="line-num">80</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
