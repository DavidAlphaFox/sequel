<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>sql_log_normalizer.rb</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>sql_log_normalizer.rb
</h1>
<div class='paths'>
lib/sequel/extensions/sql_log_normalizer.rb
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2021-10-11 08:09:16 -0700</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>The sql_log_normalizer extension normalizes the SQL that is logged, removing the literal strings and numbers in the SQL, and removing the logging of any bound variables:</p>

<pre class="ruby"><span class="ruby-identifier">ds</span> = <span class="ruby-constant">DB</span>[<span class="ruby-value">:table</span>].<span class="ruby-identifier">first</span>(<span class="ruby-value">a:</span> <span class="ruby-value">1</span>, <span class="ruby-value">b:</span> <span class="ruby-string">&#39;something&#39;</span>)
<span class="ruby-comment"># Without sql_log_normalizer extension</span>
<span class="ruby-comment"># SELECT * FROM &quot;table&quot; WHERE ((&quot;a&quot; = 1) AND (&quot;b&quot; = &#39;something&#39;)) LIMIT 1</span>

<span class="ruby-comment"># With sql_log_normalizer_extension</span>
<span class="ruby-comment"># SELECT * FROM &quot;table&quot; WHERE ((&quot;a&quot; = ?) AND (&quot;b&quot; = ?)) LIMIT ?</span>
</pre>

<p>The normalization is done by scanning the SQL string being executed for literal strings and numbers, and replacing them with question marks.  While this should work for all or almost all production queries, there are pathlogical queries that will not be handled correctly, such as the use of apostrophes in identifiers:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>[<span class="ruby-value">:&quot;asf&#39;bar&quot;</span>].<span class="ruby-identifier">where</span>(<span class="ruby-value">a:</span> <span class="ruby-value">1</span>, <span class="ruby-value">b:</span> <span class="ruby-string">&#39;something&#39;</span>).<span class="ruby-identifier">first</span>
<span class="ruby-comment"># Logged as:</span>
<span class="ruby-comment"># SELECT * FROM &quot;asf?something&#39;)) LIMIT ?</span>
</pre>

<p>The expected use case for this extension is when you want to normalize logs to group similar queries, or when you want to protect sensitive data from being stored in the logs.</p>

<p>Related module: <a href="../../../../classes/Sequel/SQLLogNormalizer.html"><code>Sequel::SQLLogNormalizer</code></a></p>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
