<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>pg_extended_integer_support.rb</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>pg_extended_integer_support.rb
</h1>
<div class='paths'>
lib/sequel/extensions/pg_extended_integer_support.rb
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2022-10-30 19:13:54 -0700</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>The pg_extended_integer_support extension supports literalizing Ruby integers outside of PostgreSQL bigint range on PostgreSQL. <a href="../../../../classes/Sequel.html"><code>Sequel</code></a> by default will raise exceptions when literalizing such integers, as PostgreSQL would treat them as numeric type values instead of integer/bigint type values if unquoted, which can result in unexpected negative performance (e.g. forcing sequential scans when index scans would be used for an integer/bigint type).</p>

<p>To load the extension into a Dataset (this returns a new Dataset):</p>

<pre class="ruby"><span class="ruby-identifier">dataset</span> = <span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">extension</span>(<span class="ruby-value">:pg_extended_integer_support</span>)
</pre>

<p>To load the extension into a Database, so it affects all of the Database’s datasets:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">extension</span> <span class="ruby-value">:pg_extended_integer_support</span>
</pre>

<p>By default, the extension will quote integers outside bigint range:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">literal</span>(<span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-value">63</span>) <span class="ruby-comment"># =&gt; &quot;&#39;9223372036854775808&#39;&quot;</span>
</pre>

<p>Quoting the value treats the type as unknown:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">get</span>{<span class="ruby-identifier">pg_typeof</span>(<span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-value">63</span>)} <span class="ruby-comment"># =&gt; &#39;unknown&#39;</span>
</pre>

<p>PostgreSQL will implicitly cast the unknown type to the appropriate database type, raising an error if it cannot be casted. Be aware this can result in the integer value being implicitly casted to text or any other PostgreSQL type:</p>

<pre class="ruby"><span class="ruby-comment"># Returns a string, not an integer:</span>
<span class="ruby-constant">DB</span>.<span class="ruby-identifier">get</span>{<span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-value">63</span>}
<span class="ruby-comment"># =&gt; &quot;9223372036854775808&quot;</span>
</pre>

<p>You can use the Dataset#integer_outside_bigint_range_strategy method with the value <code>:raw</code> to change the strategy to not quote the variable:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">dataset</span>.
  <span class="ruby-identifier">integer_outside_bigint_range_strategy</span>(<span class="ruby-value">:raw</span>).
  <span class="ruby-identifier">literal</span>(<span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-value">63</span>)
<span class="ruby-comment"># =&gt; &quot;9223372036854775808&quot;</span>
</pre>

<p>Note that not quoting the value will result in PostgreSQL treating the type as numeric instead of integer:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">dataset</span>.
  <span class="ruby-identifier">integer_outside_bigint_range_strategy</span>(<span class="ruby-value">:raw</span>).
  <span class="ruby-identifier">get</span>{<span class="ruby-identifier">pg_typeof</span>(<span class="ruby-value">2</span><span class="ruby-operator">**</span><span class="ruby-value">63</span>)}
<span class="ruby-comment"># =&gt; &quot;numeric&quot;</span>
</pre>

<p>The <code>:raw</code> behavior was Sequel’s historical behavior, but unless you fully understand the reprecussions of PostgreSQL using a numeric type for integer values, you should not use it.</p>

<p>To get the current default behavior of raising an exception for integers outside of PostgreSQL bigint range, you can use a strategy of <code>:raise</code>.</p>

<p>To specify a default strategy for handling integers outside bigint range that applies to all of a Database’s datasets, you can use the <code>:integer_outside_bigint_range_strategy</code> Database option with a value of <code>:raise</code> or <code>:raw</code>:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:integer_outside_bigint_range_strategy</span>] = <span class="ruby-value">:raw</span>
</pre>

<p>The Database option will be used as a fallback if you did not call the Dataset#integer_outside_bigint_range_strategy method to specify a strategy for the dataset.</p>

<p>Related module: <a href="../../../../classes/Sequel/Postgres/ExtendedIntegerSupport.html"><code>Sequel::Postgres::ExtendedIntegerSupport</code></a></p>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
