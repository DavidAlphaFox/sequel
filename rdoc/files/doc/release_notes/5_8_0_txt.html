<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>5.8.0.txt</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>5.8.0.txt
</h1>
<div class='paths'>
doc/release_notes/5.8.0.txt
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2018-05-01 11:42:13 -0700</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<h1 id="label-New+Features">New Features<span><a href="#label-New+Features">&para;</a> <a href="#top">&uarr;</a></span></h1>
<ul><li>
<p>A pg_auto_constraint_validations plugin has been added, which automatically converts many constraint violations raised as exceptions to ValidationFailed exceptions when saving a model instance.</p>

<p>The following constraint violation types are recognized and supported:</p>
<ul><li>
<p>NOT NULL</p>
</li><li>
<p>CHECK</p>
</li><li>
<p>UNIQUE (except expression/functional indexes)</p>
</li><li>
<p>FOREIGN KEY (both referencing and referenced by)</p>
</li></ul>

<p>In the cases where the plugin cannot determine an appropriate validation failure for the constraint violation, it just reraises the original exception.</p>

<p>This plugin is not intended as a replacement for other validations, it is intended as a last resort.  The purpose of validations is to provide nice error messages for the user, and the error messages generated by this plugin are fairly generic.  The error messages can be customized using the :messages plugin option, but there is only a single message used per constraint type.</p>
</li><li>
<p>Database#check_constraints has been added on PostgreSQL.  This returns metadata related to each check constraint on a table:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_table</span>(<span class="ruby-value">:foo</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Integer</span> <span class="ruby-value">:i</span>
  <span class="ruby-constant">Integer</span> <span class="ruby-value">:j</span>
  <span class="ruby-identifier">constraint</span>(<span class="ruby-value">:ic</span>, <span class="ruby-constant">Sequel</span>[<span class="ruby-value">:i</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>)
  <span class="ruby-identifier">constraint</span>(<span class="ruby-value">:jc</span>, <span class="ruby-constant">Sequel</span>[<span class="ruby-value">:j</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>)
  <span class="ruby-identifier">constraint</span>(<span class="ruby-value">:ijc</span>, <span class="ruby-constant">Sequel</span>[<span class="ruby-value">:i</span>] <span class="ruby-operator">-</span> <span class="ruby-constant">Sequel</span>[<span class="ruby-value">:j</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>)
<span class="ruby-keyword">end</span>
<span class="ruby-constant">DB</span>.<span class="ruby-identifier">check_constraints</span>(<span class="ruby-value">:foo</span>)
<span class="ruby-comment"># =&gt; {</span>
<span class="ruby-comment">#  :ic=&gt;{:definition=&gt;&quot;CHECK ((i &gt; 2))&quot;, :columns=&gt;[:i]},</span>
<span class="ruby-comment">#  :jc=&gt;{:definition=&gt;&quot;CHECK ((j &gt; 2))&quot;, :columns=&gt;[:j]},</span>
<span class="ruby-comment">#  :ijc=&gt;{:definition=&gt;&quot;CHECK (((i - j) &gt; 2))&quot;, :columns=&gt;[:i, :j]}</span>
<span class="ruby-comment"># }</span>
</pre>
</li><li>
<p>Database#foreign_key_list now supports a :reverse option on PostgreSQL, which returns foreign keys referencing the given table, instead of of foreign keys in the given table referencing other tables:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_table!</span>(<span class="ruby-value">:a</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
  <span class="ruby-constant">Integer</span> <span class="ruby-value">:i</span>
  <span class="ruby-constant">Integer</span> <span class="ruby-value">:j</span>
  <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:a_id</span>, <span class="ruby-value">:a</span>, <span class="ruby-value">:foreign_key_constraint_name</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:a_a</span>
  <span class="ruby-identifier">unique</span> [<span class="ruby-value">:i</span>, <span class="ruby-value">:j</span>]
<span class="ruby-keyword">end</span>
<span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_table!</span>(<span class="ruby-value">:b</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:a_id</span>, <span class="ruby-value">:a</span>, <span class="ruby-value">:foreign_key_constraint_name</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:a_a</span>
  <span class="ruby-constant">Integer</span> <span class="ruby-value">:c</span>
  <span class="ruby-constant">Integer</span> <span class="ruby-value">:d</span>
  <span class="ruby-identifier">foreign_key</span> [<span class="ruby-value">:c</span>, <span class="ruby-value">:d</span>], <span class="ruby-value">:a</span>, <span class="ruby-value">:key</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-value">:j</span>, <span class="ruby-value">:i</span>], <span class="ruby-value">:name</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:a_c_d</span>
<span class="ruby-keyword">end</span>
<span class="ruby-constant">DB</span>.<span class="ruby-identifier">foreign_key_list</span>(<span class="ruby-value">:a</span>, <span class="ruby-value">:reverse</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)
<span class="ruby-comment"># =&gt; [</span>
<span class="ruby-comment">#  {:name=&gt;:a_a, :columns=&gt;[:a_id], :key=&gt;[:id], :on_update=&gt;:no_action,</span>
<span class="ruby-comment">#   :on_delete=&gt;:no_action, :deferrable=&gt;false, :table=&gt;:a, :schema=&gt;:public},</span>
<span class="ruby-comment">#  {:name=&gt;:a_a, :columns=&gt;[:a_id], :key=&gt;[:id], :on_update=&gt;:no_action,</span>
<span class="ruby-comment">#   :on_delete=&gt;:no_action, :deferrable=&gt;false, :table=&gt;:b, :schema=&gt;:public},</span>
<span class="ruby-comment">#  {:name=&gt;:a_c_d, :columns=&gt;[:c, :d], :key=&gt;[:j, :i], :on_update=&gt;:no_action,</span>
<span class="ruby-comment">#   :on_delete=&gt;:no_action, :deferrable=&gt;false, :table=&gt;:b, :schema=&gt;:public}</span>
<span class="ruby-comment"># ]</span>
</pre>
</li><li>
<p>Dataset#nowait has been added, which will make the query fail with a Sequel::DatabaseLockTimeout exception if it encounters a locked row, overriding the default database behavior that would wait until the lock was released. This method is supported on PostgreSQL, Microsoft SQL Server, Oracle, and MySQL 8+.</p>
</li><li>
<p>Database#indexes now supports an :include_partial option on PostgreSQL, which will include partial indexes in the output (<a href="../../../classes/Sequel.html"><code>Sequel</code></a> by default excludes partial indexes).</p>
</li><li>
<p>Common table expressions and window functions are now supported when using MySQL 8+.</p>
</li><li>
<p>Dataset#skip_locked is now supported on MySQL 8+.</p>
</li><li>
<p>The connection_expiration extension now supports a Database#connection_expiration_random_delay attribute, which is used to randomize the expiration times, avoiding the thundering herd problem.</p>
</li><li>
<p>The pg_enum extension now supports a rename_enum method for renaming existing enum types.</p>
</li><li>
<p>Database#error_info on PostgreSQL now returns much more metadata regarding the error.</p>
</li></ul>

<h1 id="label-Other+Improvements">Other Improvements<span><a href="#label-Other+Improvements">&para;</a> <a href="#top">&uarr;</a></span></h1>
<ul><li>
<p>The dataset returned by the following dataset methods is cached, which can improve performance significantly in certain cases:</p>
<ul><li>
<p>distinct (without arguments or block)</p>
</li><li>
<p>from_self (without options)</p>
</li><li>
<p>lateral</p>
</li><li>
<p>qualify (without argument)</p>
</li><li>
<p>returning (without arguments)</p>
</li><li>
<p>select_all (without arguments)</p>
</li></ul>
</li><li>
<p>If the primary_key serial: true, type: :serial, or type: :bigserial options are given on PostgreSQL 10.2+, use a serial primary key instead of an identity primary key.  This change was included in <a href="../../../classes/Sequel.html"><code>Sequel</code></a> 5.7.1.</p>
</li><li>
<p>The :search_path Database option is now supported as a shard option on PostgreSQL, so different shards can use different search paths.</p>
</li><li>
<p>The correct column order in Database#foreign_key_list on MySQL is now forced, fixing issues on MySQL 8+.</p>
</li><li>
<p>When using case sensitive regexp matches on MySQL 8+, <a href="../../../classes/Sequel.html"><code>Sequel</code></a> now uses the REGEXP_LIKE function instead of the REGEXP BINARY operator, to work around what appears to be a bug in MySQL 8+ related to the change in MySQL’s regexp engine.</p>
</li><li>
<p>On MySQL 5.7+, the :extended option to Dataset#explain is now ignored, since the :extended option’s behavior in previous MySQL versions is now the default behavior.</p>
</li><li>
<p>The MySQL HY000 generic SQL state error code is now ignored in the mysql2 adapter, so it falls back to using the more accurate backup error mapping in that case.</p>
</li><li>
<p>The pg_enum extension’s schema modification methods now work correctly if the Database instance is frozen.</p>
</li><li>
<p>The tactical_eager_loading plugin now respects the :allow_eager association option, and will not attempt to eagerly load associations when :allow_eager is false.</p>
</li><li>
<p>Using multiple add_constraint calls and a set_column_null call in the same alter_table block on SQLite now works correctly.  Note that if you are planning on ever modifying existing tables beyond adding columns, you should probably choose a database that natively supports such modification (SQLite does not).</p>
</li><li>
<p>Hashes returned by Database#foreign_key_list on PostgreSQL now include a :schema entry, unless the support has been enabled to make the :table entry be a qualified identifier.</p>
</li><li>
<p>Dataset#support_cte?(:insert) no longer returns true on SQLAnywhere.  SQLAnywhere only supports common table expressions for INSERT … SELECT, not for all INSERT statements. INSERT … WITH … SELECT is already supported in <a href="../../../classes/Sequel.html"><code>Sequel</code></a> using:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>[<span class="ruby-value">:t1</span>].<span class="ruby-identifier">insert</span>(<span class="ruby-constant">DB</span>[<span class="ruby-value">:t2</span>].<span class="ruby-identifier">with</span>(<span class="ruby-constant">DB</span>[<span class="ruby-value">:t3</span>]))
</pre>
</li><li>
<p>Model#_valid? is no longer made a public method in the error_splitter plugin.</p>
</li></ul>

<h1 id="label-Backwards+Compatibility">Backwards Compatibility<span><a href="#label-Backwards+Compatibility">&para;</a> <a href="#top">&uarr;</a></span></h1>
<ul><li>
<p>Calling the filter method on a proxy object returned by the association_proxies plugin now warns on ruby &lt;2.6.  This is because starting in ruby 2.6, the behavior will change and the method will be called on the array of associated objects instead of on the dataset, as Enumerable#filter is being added in ruby 2.6.</p>
</li></ul>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
